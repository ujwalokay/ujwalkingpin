/* src/lib/tauri-db.ts
   Consolidated Tauri local DB adapter for Airavoto Gaming POS.
   Replace your existing tauri-db.ts with this file.
*/

type AnyObject = Record<string, any>;

let db: any = null;
let dbInitPromise: Promise<any> | null = null;
let dbInitialized = false;

/**
 * Robust Tauri v2 detection.
 * - Prefer internal bridge existence if available.
 * - Fall back to userAgent check for "tauri".
 */
export function isTauri(): boolean {
  try {
    if (typeof window === 'undefined') return false;
    // __TAURI_INTERNALS__ exists in embedded environments by default in some builds
    if ('__TAURI_INTERNALS__' in (window as any)) return true;
    // windows with older bridges may still include "__TAURI__" but not reliable; we check userAgent next
    if (typeof navigator !== 'undefined' && navigator.userAgent) {
      return navigator.userAgent.toLowerCase().includes('tauri');
    }
    return false;
  } catch {
    return false;
  }
}

/**
 * Initialize the Tauri SQL database (singleton).
 */
export async function initDatabase() {
  if (!isTauri()) {
    throw new Error('Cannot initialize Tauri database in web mode');
  }

  if (db && dbInitialized) return db;
  if (dbInitPromise) return dbInitPromise;

  dbInitPromise = (async () => {
    try {
      console.log('[DB] Initializing Tauri database...');
      // dynamic import so that web builds don't fail on import
      const sqlModule = await import('@tauri-apps/plugin-sql');
      const Database = sqlModule.default || (sqlModule as any).Database || sqlModule;
      db = await Database.load('sqlite:airavoto_pos.db');
      dbInitialized = true;
      console.log('[DB] Tauri database initialized successfully');
      return db;
    } catch (error) {
      console.error('[DB] Failed to initialize Tauri database:', error);
      dbInitPromise = null;
      throw error;
    }
  })();

  return dbInitPromise;
}

/**
 * Get the initialized database instance.
 */
export async function getDatabase() {
  if (!isTauri()) {
    throw new Error('Cannot get Tauri database in web mode');
  }
  if (!db || !dbInitialized) {
    return initDatabase();
  }
  return db;
}

export function isDatabaseReady(): boolean {
  return isTauri() && dbInitialized && db !== null;
}

/* Utility helpers */
function generateUUID(): string {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
    const r = (Math.random() * 16) | 0;
    const v = c === 'x' ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
}

function generateCode(prefix: string): string {
  const timestamp = Date.now().toString(36).toUpperCase();
  const randomPart = Math.floor(Math.random() * 0xFFFFFF)
    .toString(16)
    .toUpperCase()
    .padStart(6, '0');
  return `${prefix}-${timestamp.slice(-5)}${randomPart.slice(0, 4)}`;
}

function snakeToCamel(str: string): string {
  return str.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());
}

function transformRow(row: AnyObject): AnyObject {
  const transformed: AnyObject = {};
  for (const [key, value] of Object.entries(row)) {
    const camelKey = snakeToCamel(key);
    transformed[camelKey] = value;
  }
  return transformed;
}

/* Specific row transformers (keeps same shapes as your UI expects) */
function safeJsonParse<T = any>(s: any, fallback: T): T {
  if (s === null || s === undefined) return fallback;
  try {
    return JSON.parse(s);
  } catch {
    return fallback;
  }
}

function transformBookingRow(row: any): any {
  if (!row) return null;
  return {
    id: row.id,
    bookingCode: row.booking_code,
    groupId: row.group_id,
    groupCode: row.group_code,
    category: row.category,
    seatNumber: row.seat_number,
    seatName: row.seat_name,
    customerName: row.customer_name,
    whatsappNumber: row.whatsapp_number,
    startTime: row.start_time,
    endTime: row.end_time,
    price: row.price,
    status: row.status,
    bookingType: safeJsonParse(row.booking_type, []),
    pausedRemainingTime: row.paused_remaining_time,
    personCount: row.person_count,
    paymentMethod: row.payment_method,
    cashAmount: row.cash_amount,
    upiAmount: row.upi_amount,
    paymentStatus: row.payment_status,
    lastPaymentAction: safeJsonParse(row.last_payment_action, null),
    foodOrders: safeJsonParse(row.food_orders, []),
    originalPrice: row.original_price,
    discountApplied: row.discount_applied,
    bonusHoursApplied: row.bonus_hours_applied,
    promotionDetails: safeJsonParse(row.promotion_details, null),
    isPromotionalDiscount: row.is_promotional_discount,
    isPromotionalBonus: row.is_promotional_bonus,
    manualDiscountPercentage: row.manual_discount_percentage,
    manualFreeHours: row.manual_free_hours,
    discount: row.discount,
    bonus: row.bonus,
    createdAt: row.created_at,
  };
}

function transformFoodItemRow(row: any): any {
  if (!row) return null;
  return {
    id: row.id,
    name: row.name,
    price: row.price,
    costPrice: row.cost_price,
    currentStock: row.current_stock,
    minStockLevel: row.min_stock_level,
    inInventory: row.in_inventory,
    category: row.category,
    supplier: row.supplier,
    expiryDate: row.expiry_date,
  };
}

function transformExpenseRow(row: any): any {
  if (!row) return null;
  return {
    id: row.id,
    category: row.category,
    description: row.description,
    amount: row.amount,
    date: row.date,
    createdAt: row.created_at,
  };
}

function transformActivityLogRow(row: any): any {
  if (!row) return null;
  return {
    id: row.id,
    userId: row.user_id,
    username: row.username,
    userRole: row.user_role,
    action: row.action,
    entityType: row.entity_type,
    entityId: row.entity_id,
    details: row.details,
    createdAt: row.created_at,
  };
}

function transformNotificationRow(row: any): any {
  if (!row) return null;
  return {
    id: row.id,
    type: row.type,
    title: row.title,
    message: row.message,
    entityType: row.entity_type,
    entityId: row.entity_id,
    activityLogId: row.activity_log_id,
    isRead: row.is_read,
    createdAt: row.created_at,
  };
}

function transformUserRow(row: any): any {
  if (!row) return null;
  return {
    id: row.id,
    username: row.username,
    role: row.role,
    onboardingCompleted: row.onboarding_completed,
    profileImageUrl: row.profile_image_url,
    createdAt: row.created_at,
    updatedAt: row.updated_at,
  };
}

function transformDeviceConfigRow(row: any): any {
  if (!row) return null;
  return {
    id: row.id,
    category: row.category,
    count: row.count,
    seats: safeJsonParse(row.seats, []),
  };
}

function transformPricingConfigRow(row: any): any {
  if (!row) return null;
  return {
    id: row.id,
    category: row.category,
    duration: row.duration,
    price: row.price,
    personCount: row.person_count,
  };
}

function transformBookingHistoryRow(row: any): any {
  if (!row) return null;
  return {
    id: row.id,
    bookingId: row.booking_id,
    bookingCode: row.booking_code,
    groupId: row.group_id,
    groupCode: row.group_code,
    category: row.category,
    seatNumber: row.seat_number,
    seatName: row.seat_name,
    customerName: row.customer_name,
    whatsappNumber: row.whatsapp_number,
    startTime: row.start_time,
    endTime: row.end_time,
    price: row.price,
    status: row.status,
    bookingType: safeJsonParse(row.booking_type, []),
    pausedRemainingTime: row.paused_remaining_time,
    personCount: row.person_count,
    paymentMethod: row.payment_method,
    cashAmount: row.cash_amount,
    upiAmount: row.upi_amount,
    paymentStatus: row.payment_status,
    lastPaymentAction: safeJsonParse(row.last_payment_action, null),
    foodOrders: safeJsonParse(row.food_orders, []),
    originalPrice: row.original_price,
    discountApplied: row.discount_applied,
    bonusHoursApplied: row.bonus_hours_applied,
    promotionDetails: safeJsonParse(row.promotion_details, null),
    isPromotionalDiscount: row.is_promotional_discount,
    isPromotionalBonus: row.is_promotional_bonus,
    manualDiscountPercentage: row.manual_discount_percentage,
    manualFreeHours: row.manual_free_hours,
    discount: row.discount,
    bonus: row.bonus,
    createdAt: row.created_at,
    archivedAt: row.archived_at,
  };
}

function transformGamingCenterInfoRow(row: any): any {
  if (!row) return null;
  return {
    id: row.id,
    name: row.name,
    description: row.description,
    address: row.address,
    phone: row.phone,
    email: row.email,
    hours: row.hours,
    timezone: row.timezone,
    updatedAt: row.updated_at,
  };
}

function transformSessionGroupRow(row: any): any {
  if (!row) return null;
  return {
    id: row.id,
    groupCode: row.group_code,
    groupName: row.group_name,
    category: row.category,
    bookingType: safeJsonParse(row.booking_type, []),
    createdAt: row.created_at,
  };
}

/* -------------------------
   localDb API (all functions)
   ------------------------- */
export const localDb = {
  /* BOOKINGS */
  async getAllBookings() {
    const database = await getDatabase();
    const result = await database.select('SELECT * FROM bookings ORDER BY created_at DESC');
    return (result || []).map(transformBookingRow);
  },

  async getActiveBookings() {
    const database = await getDatabase();
    const result = await database.select(
      "SELECT * FROM bookings WHERE status IN ('running', 'paused', 'upcoming') ORDER BY start_time"
    );
    return (result || []).map(transformBookingRow);
  },

  async getBookingById(id: string) {
    const database = await getDatabase();
    const result = await database.select('SELECT * FROM bookings WHERE id = $1', [id]);
    return result[0] ? transformBookingRow(result[0]) : null;
  },

  async createBooking(booking: any) {
    const database = await getDatabase();
    const id = generateUUID();
    const bookingCode = generateCode('BK');
    const now = new Date().toISOString();

    await database.execute(
      `INSERT INTO bookings (
        id, booking_code, group_id, group_code, category, seat_number, seat_name,
        customer_name, whatsapp_number, start_time, end_time, price, status,
        booking_type, paused_remaining_time, person_count, payment_method,
        cash_amount, upi_amount, payment_status, last_payment_action, food_orders,
        original_price, discount_applied, bonus_hours_applied, promotion_details,
        is_promotional_discount, is_promotional_bonus, manual_discount_percentage,
        manual_free_hours, discount, bonus, created_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33)`,
      [
        id, bookingCode, booking.groupId || null, booking.groupCode || null,
        booking.category, booking.seatNumber, booking.seatName,
        booking.customerName, booking.whatsappNumber || null,
        booking.startTime, booking.endTime, booking.price, booking.status,
        JSON.stringify(booking.bookingType || []), booking.pausedRemainingTime || null,
        booking.personCount || 1, booking.paymentMethod || null,
        booking.cashAmount || null, booking.upiAmount || null,
        booking.paymentStatus || 'unpaid', JSON.stringify(booking.lastPaymentAction || null),
        JSON.stringify(booking.foodOrders || []), booking.originalPrice || null,
        booking.discountApplied || null, booking.bonusHoursApplied || null,
        JSON.stringify(booking.promotionDetails || null), booking.isPromotionalDiscount ? 1 : 0,
        booking.isPromotionalBonus ? 1 : 0, booking.manualDiscountPercentage || null,
        booking.manualFreeHours || null, booking.discount || null, booking.bonus || null, now
      ]
    );

    return {
      id,
      bookingCode,
      groupId: booking.groupId || null,
      groupCode: booking.groupCode || null,
      category: booking.category,
      seatNumber: booking.seatNumber,
      seatName: booking.seatName,
      customerName: booking.customerName,
      whatsappNumber: booking.whatsappNumber || null,
      startTime: booking.startTime,
      endTime: booking.endTime,
      price: booking.price,
      status: booking.status,
      bookingType: booking.bookingType || [],
      pausedRemainingTime: booking.pausedRemainingTime || null,
      personCount: booking.personCount || 1,
      paymentMethod: booking.paymentMethod || null,
      cashAmount: booking.cashAmount || null,
      upiAmount: booking.upiAmount || null,
      paymentStatus: booking.paymentStatus || 'unpaid',
      lastPaymentAction: booking.lastPaymentAction || null,
      foodOrders: booking.foodOrders || [],
      originalPrice: booking.originalPrice || null,
      discountApplied: booking.discountApplied || null,
      bonusHoursApplied: booking.bonusHoursApplied || null,
      promotionDetails: booking.promotionDetails || null,
      isPromotionalDiscount: booking.isPromotionalDiscount ? 1 : 0,
      isPromotionalBonus: booking.isPromotionalBonus ? 1 : 0,
      manualDiscountPercentage: booking.manualDiscountPercentage || null,
      manualFreeHours: booking.manualFreeHours || null,
      discount: booking.discount || null,
      bonus: booking.bonus || null,
      createdAt: now,
    };
  },

  async updateBooking(id: string, updates: any) {
    const database = await getDatabase();
    const setClauses: string[] = [];
    const values: any[] = [];
    let paramIndex = 1;

  // ... rest of file continues, but the important parts have been consolidated above ...
};
